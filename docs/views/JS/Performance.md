---
title: '关于性能优化'
date: 2020-10-08
tags:
- '性能优化'
- '学习笔记'
categories:
- '性能优化'
---

关于性能优化的概念,和内存优化的一些简单算法

<!-- more -->


# 关于性能优化

## 介绍

- 性能优化是不可避免的
- 哪些内容可以看做是性能优化
- 无处不在的前端性能优化

## JavaScript语言优化

### 内存管理

#### 介绍

- 内存:由可读写单元组成,便是一片可操作性空间
- 管理:人为的去操作一片空间的申请,使用和释放
- 内存管理: 开发者主动申请空间,使用空间,释放空间
- 管理流程:申请 -- 使用 -- 释放

#### JavaScript中的内存管理

- 申请内存空间
- 使用内存空间
- 释放内存空间

### 垃圾回收与常见GC算法

#### JavaScript中的垃圾

- JavaScript 中内存管理是自动的
- 对象不再被引用时是垃圾
- 对象不能从根上访问到时是垃圾

#### JavaScript中的可达对象

- 可以访问到的对象就是可达对象(引用,作用域链)
- 可达的标准就是从根出发是否能够被找到
- JavaScript中的根就可以理解为是全局变量对象

##### 介绍

- GC 就是垃圾回收机制的简写
- GC 可以找到内存中的垃圾,并释放和回收空间
- 算法就是工作时查找和回收所遵循的规则

##### 常见 GC 算法

###### 引用计数

- 核心思想: 设置引用数,判断当前引用数是否为0
- 引用计数器
- 当引用关系改变时修改引用数字
- 引用数字为0时立即回收

```js
const user1 = {age:11}
const user2 = {age:22}
const user3 = {age:33}

const nameList = [user1.age,user2.age,user3.age]
// user1 user2 user3 仍然被引用 所以不会被回收


function fn(){
  const num1 = 1;
  const num2 = 2;
}

fn(); //在执行后 内部num1 num2 就会被回收
```

- 优点:
> 1. 发现垃圾时立即回收
> 2. 最大限度减少程序暂停

- 缺点:
> 1. 无法回收循环引用的对象
> 2. 时间开销大

###### 标记清除

- 原理

> 1. 核心思想 : 分标记和清楚二个阶段完成
> 2. 遍历所有对象找标记活动对象
> 3. 遍历所有对象清楚没有标记的对象
> 4. 回收相应的空间

- 优点
> 1. 解决循环引用对象的问题

- 缺点
> 1. 释放后地址不连续(空间碎片化)
> 2. 不能立即回收垃圾对象

###### 标记整理

- 原理
> 1. 标记整理可以看做是标记清除的增强
> 2. 标记阶段的操作和标记清除一致
> 3. 清除阶段会先执行整理,移动对象位置

- 优点:
> 1. 减少碎片化空间

- 缺点
> 1. 不能立即回收垃圾对象

### V8 引擎的垃圾回收

- 认识V8

> 1. V8 是一款主流的JavaScript执行引擎
> 2. V8 采用即时编译
> 3. V8 内存设限

- V8 垃圾回收策略

> 1. 采用分代回收的思想
> 2. 内存分为新生代,老生代
> 3. 针对不同对象采用不同算法

- V8 中常用的 GC 算法

> 1. 分代回收
> 2. 空间赋值
> 3. 标记清除
> 4. 标记整理
> 5. 标记增量

- V8 新生代对象

> 1. V8 内存空间一分为二
> 2. 小空间用于存储新生代对象(32M|16M)
> 3. 新生代指的是存活时间较短的对象(如局部变量)

- V8 如何回收新生代对象

> 1. 回收过程采用复制算法 + 标记整理
> 2. 新生代内存区分为二个等大小空间 (From | to)
> 3. 使用空间为 From , 空闲空间为 To
> 4. 活动对象存储于 From 空间
> 5. 标记整理后将活动对象拷贝值 To
> 6. From 与 To 交换空间完成释放

- V8 如何回收新生代对象细节说明

> 1. 拷贝过程中可能出现晋升
> 2. 晋升就是将新生代对象移动至老生代
> 3. 一轮GC还存活的新生代需要晋升
> 4. To 空间的使用率超过25%

- V8 老年代对象

> 1. 老年代对象存放在右侧老生代区域
> 2. 64位操作系统 1.4G,32G操作系统700M
> 3. 老年代对象就是指存活时间较长的对象

- V8 老年代对象回收实现

> 1. 主要采用标记清除,标记整理,增量标记算法
> 2. 首先使用标记清除完成垃圾空间的回收
> 3. 采用标记整理进行空间优化
> 4. 采用增量标记进行效率优化

- 新生代区域和老年代区域细节对比

> 1. 新生代区域垃圾回收使用空间换时间
> 2. 老生代区域垃圾回收不适合复制算法

- 总结

> 1. V8 是一款主流的JavaScript执行引擎
> 2. V8 内存设置上限
> 3. V8 采用基于分代回收思想实现垃圾回收
> 4. V8 内存分为新生代和老生代
> 5. V8 垃圾回收常见 GC 算法

### Performance 工具

- 为什么使用 Performance

> 1. GC 的目的是为了实现内存空间的良性循环
> 2. 良性循环的基石是合理使用
> 3. 时刻关注才能确定是否合理
> 4. Performance 提供多种监控方法

总结: **通过Performance时刻监控内存**

- 使用步骤

> 1. 打开浏览器输入目标网站
> 2. 进入开发人员工具面板,选择性能
> 3. 开启录制功能,访问具体界面
> 4. 执行用户行为,一段时间后停止录制
> 5. 分析界面中记录的内存信息

- 出现问题的体现

> 1. 页面出现延迟加载或经常性暂停
> 2. 页面持续性出现糟糕的性能
> 3. 页面的性能随时间延长越来越差
